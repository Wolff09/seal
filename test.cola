
struct Node {
	data_t data;
	Node* next;
}

Node* Head, Tail;

extern void retire(Node* ptr);
extern void protect1(Node* ptr);
extern void protect2(Node* ptr);

void init() {
	Head = malloc;
	Head->next = NULL;
	Tail = Head;
}

void enqueue(data_t input) {
	Node* tail, next, node, tmp;
	bool done;
	atomic {
		node = malloc;
	}
	atomic {
		node->data = input;
	}
	atomic {
		node->next = NULL;
	}
	atomic {
		done = false;
	}
	loop {
		atomic {
			assume(done == false);
		}
		choose {
			atomic {
				// assert(active(Tail));
				tail = Tail;
				protect1(tail);
				assume(tail == Tail);
			}
			atomic {
				next = tail->next;
			}
			choose {
				atomic {
					assume(tail != Tail);
				}
			}{
				atomic {
					// assert(active(Tail));
					assume(tail == Tail);
					// assert(active(next));
				}
				choose {
					atomic {
						assume(next != NULL);
					}
					choose {
						atomic {
							// assert(active(Tail));
							assume(tail == Tail);
							Tail = next;
						}
					}{
						atomic {
							assume(tail != Tail);
						}
					}
				}{
					atomic {
						// assert(active(next));
						assume(next == NULL);
					}
					choose {
						atomic {
							tmp = tail->next;
							// assert(active(next));
							// assert(active(tmp));
							assume(tmp == next);
							tail->next = node;
						}
						atomic {
							done = true;
						}
					}{
						atomic {
							tmp = tail->next;
							assume(tmp != next);
						}
					}
				}
			}
		}{
			atomic {
				tail = Tail;
			}
			atomic {
				protect1(tail);
			}
			atomic {
				assume(tail != Tail);
			}
		}
	}
	atomic {
		assume(done == true);
	}
	choose {
		atomic {
			// assert(active(Tail));
			// assert(active(tail));
			assume(tail == Tail);
			Tail = node;
		}
	}{
		atomic {
			assume(tail != Tail);
		}
	}
}

void dequeue() {
	Node* head, next, tail, tmp;
	bool done;
	data_t result;
	atomic {
		done = false;
	}
	loop {
		atomic {
			assume(done == false);
		}
		choose {
			atomic {
				// assert(active(Head));
				head = Head;
				protect1(head);
				assume(head == Head);
			}
			choose {
				atomic {
					tail = Tail;
					// assert(active(tail));
					assume(head == tail);
				}
				atomic {
					next = head->next;
				}
				atomic {
					protect2(next);
				}
				choose {
					atomic {
						assume(head != Head);
					}
				}{
					atomic {
						// assert(active(Head));
						assume(head == Head);
						// assert(active(next));
					}
					choose {
						atomic {
							assume(next == NULL);
						}
						atomic {
							result = EMPTY;
						}
						atomic {
							done = true;
						}
					}{
						atomic {
							assume(next != NULL);
						}
						choose {
							atomic {
								// assert(active(Tail));
								assume(tail == Tail);
								Tail = next;
							}
						}{
							atomic {
								assume(tail != Tail);
							}
						}
					}
				}
			}{
				atomic {
					tail = Tail;
					assume(head != tail);
				}
				atomic {
					next = head->next;
				}
				atomic {
					protect2(next);
				}
				choose {
					atomic {
						assume(head != Head);
					}
				}{
					atomic {
						// assert(active(Head));
						assume(head == Head);
						// assert(active(next));
					}
					choose {
						atomic {
							assume(next == NULL);
						}
						atomic {
							result = EMPTY;
						}
						atomic {
							done = true;
						}
					}{
						atomic {
							assume(next != NULL);
						}
						atomic {
							result = next->data;
						}
						choose {
							atomic {
								// assert(active(Head));
								assume(head == Head);
								Head = next;
							}
							atomic {
								// assert(active(head));
								retire(head);
							}
							atomic {
								done = true;
							}
						}{
							atomic {
								assume(head != Head);
							}
						}
					}
				}
			}
		}{
			atomic {
				head = Head;
			}
			atomic {
				protect1(head);
			}
			atomic {
				assume(head != Head);
			}
		}
	}
	atomic {
		assume(done == true);
	}
}
